# Maintainer: Kitty Panics

pkgname=jetbra.in
pkgver=2023.09.14
pkgrel=1
url="https://3.jetbra.in/"
pkgdesc="A Java instrumentation framework for JetBrains IDE testing purposes only."
arch=('any')
license=('GPL3')
provides=("${pkgname}" "ja-netfilter")
conflicts=("${pkgname}" "ja-netfilter")
depends=('java-environment')
install="${pkgname}.install"
_zip="jetbra-ded4f9dc4fcb60294b21669dafa90330f2713ce4.zip"
_code="bafybeia4nrbuvpfd6k7lkorzgjw3t6totaoko7gmvq5pyuhl2eloxnfiri"
_url="https://ipfs.io/ipfs/${_code}" # 不保证服务一直可用
source=("${_url}/files/${_zip}"
        "${pkgname}.install")
sha256sums=('SKIP'
            '841ef4a86dae3f52656a4f3474d430be37760e1a38ec9ec585a38d0198458d5f')

package() {
    # create dir
    install -dm755 "${pkgdir}"/etc/"${pkgname}"/
    install -dm755 "${pkgdir}"/usr/share/doc/"${pkgname}"/
    install -dm755 "${pkgdir}"/usr/share/java/"${pkgname}"/

    # package files
    bsdtar --strip-components 1 -xf "${srcdir}"/"${_zip}" \
                                 -C "${pkgdir}"/usr/share/java/"${pkgname}"/
    # etc
    mv "${pkgdir}"/usr/share/java/"${pkgname}"/vmoptions \
       "${pkgdir}"/etc/"${pkgname}"/
    for i in `find "${pkgdir}"/etc/"${pkgname}"/vmoptions -type f`; do
        echo "-javaagent:/usr/share/java/${pkgname}/ja-netfilter.jar=jetbrains" >> "$i"
    done

    # doc
    ln -s /usr/share/java/"${pkgname}"/README.pdf \
          "${pkgdir}"/usr/share/doc/"${pkgname}"/
    ln -s /usr/share/java/"${pkgname}"/readme.txt \
          "${pkgdir}"/usr/share/doc/"${pkgname}"/

    # useless files
    rm -r "${pkgdir}"/usr/share/java/"${pkgname}"/{scripts,sha1sum.txt}
}
